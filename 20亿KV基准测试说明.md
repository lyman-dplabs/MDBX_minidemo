# 20亿KV基准测试脚本使用说明

## 概述

本项目提供了两个专门的基准测试脚本，用于在20亿条KV数据中进行大规模性能测试：

- `bench_mdbx_2billion.sh` - MDBX数据库基准测试
- `bench_rocksdb_2billion.sh` - RocksDB数据库基准测试

## 测试参数

- **总KV对数**: 20亿 (2,000,000,000)
- **测试KV对数**: 10万 (100,000)
- **测试轮次**: 100次
- **测试模式**: 读取、写入、更新、混合读写(8:2比例)

## 文件结构

```
MDBX_minidemo/
├── bench_mdbx_2billion.sh          # MDBX基准测试脚本
├── bench_rocksdb_2billion.sh       # RocksDB基准测试脚本
├── configs/
│   └── bench_2billion.json         # 20亿KV基准测试配置
└── logs/                           # 日志文件目录
    ├── mdbx_bench_2billion_*.log   # MDBX测试日志
    ├── mdbx_bench_2billion_*_summary.txt  # MDBX测试摘要
    ├── rocksdb_bench_2billion_*.log       # RocksDB测试日志
    └── rocksdb_bench_2billion_*_summary.txt  # RocksDB测试摘要
```

## 使用方法

### 1. MDBX基准测试

```bash
# 使用默认配置运行
./bench_mdbx_2billion.sh

# 使用自定义环境配置
./bench_mdbx_2billion.sh --config configs/mdbx_env_performance.json

# 使用自定义基准测试配置
./bench_mdbx_2billion.sh --bench-config configs/bench_2billion.json

# 使用两个自定义配置
./bench_mdbx_2billion.sh \
  --config configs/mdbx_env_performance.json \
  --bench-config configs/bench_2billion.json

# 跳过构建，直接运行
./bench_mdbx_2billion.sh --run-only

# 清理构建后运行
./bench_mdbx_2billion.sh --clean
```

### 2. RocksDB基准测试

```bash
# 使用默认配置运行
./bench_rocksdb_2billion.sh

# 使用自定义环境配置
./bench_rocksdb_2billion.sh --config configs/rocksdb_high_throughput.json

# 使用自定义基准测试配置
./bench_rocksdb_2billion.sh --bench-config configs/bench_2billion.json

# 使用两个自定义配置
./bench_rocksdb_2billion.sh \
  --config configs/rocksdb_high_throughput.json \
  --bench-config configs/bench_2billion.json

# 跳过构建，直接运行
./bench_rocksdb_2billion.sh --run-only

# 清理构建后运行
./bench_rocksdb_2billion.sh --clean
```

## 日志文件

### 日志文件命名规则

- **完整日志**: `{数据库类型}_bench_2billion_{时间戳}.log`
- **测试摘要**: `{数据库类型}_bench_2billion_{时间戳}_summary.txt`

时间戳格式: `YYYYMMDD_HHMMSS`

### 日志内容

#### 完整日志文件包含:
- 测试开始和结束时间
- 测试参数配置
- 详细的性能指标
- 每轮测试的详细结果
- 延迟统计和吞吐量数据

#### 摘要文件包含:
- 测试参数摘要
- 关键性能指标
- 平均延迟统计
- 吞吐量摘要

## 测试流程

1. **环境准备**: 清理现有数据库，创建新的测试环境
2. **数据填充**: 向数据库插入20亿条KV数据
3. **基准测试**: 执行4种测试模式，每种100轮：
   - 读取测试 (100轮)
   - 写入测试 (100轮)  
   - 更新测试 (100轮)
   - 混合读写测试 (100轮，8:2比例)
4. **结果汇总**: 生成详细的性能统计和摘要

## 性能指标

每个测试模式都会记录以下指标：

- **延迟统计**:
  - 平均延迟 (μs)
  - Tp99延迟 (μs)
  - 操作成功率

- **吞吐量**:
  - 每秒操作数 (ops/sec)
  - 总处理时间
  - 提交时间

- **混合测试特殊指标**:
  - 读取操作统计
  - 写入操作统计
  - 8:2读写比例验证

## 注意事项

1. **存储空间**: 20亿KV数据需要大量存储空间，确保有足够的磁盘空间
2. **内存使用**: 测试过程中会使用大量内存，建议在内存充足的机器上运行
3. **运行时间**: 完整测试可能需要数小时，建议在后台运行
4. **日志文件**: 日志文件会很大，定期清理旧的日志文件

## 示例输出

### 日志文件示例
```
=============================================================================
MDBX 20亿KV基准测试日志
=============================================================================
开始时间: Mon Sep 16 21:54:21 CST 2024
测试参数:
  - 总KV对数: 2000000000 (20亿)
  - 测试KV对数: 100000 (10万)
  - 测试轮次: 100 (100次)
  - 数据库路径: /tmp/mdbx_bench_2billion
=============================================================================

=== MDBX Performance Benchmark ===
Testing MDBX performance with 32-byte keys and 32-byte values
Total KV pairs in DB: 2000000000
KV pairs per test round: 100000
Number of test rounds: 100
Database path: /tmp/mdbx_bench_2billion

=== Setting up Test Environment ===
✓ Cleaned existing database at: /tmp/mdbx_bench_2billion
✓ Opened MDBX environment at: /tmp/mdbx_bench_2billion

=== Populating Database ===
Inserting 2000000000 KV pairs into database
  Inserted 100000/2000000000 KV pairs
  ...
✓ Database populated with 2000000000 KV pairs in 1800 seconds
```

### 摘要文件示例
```
=============================================================================
MDBX 20亿KV基准测试摘要
=============================================================================
测试时间: Mon Sep 16 22:30:15 CST 2024
日志文件: /home/user/MDBX_minidemo/logs/mdbx_bench_2billion_20240916_215421.log

测试参数:
  - 总KV对数: 2000000000 (20亿)
  - 测试KV对数: 100000 (10万)
  - 测试轮次: 100 (100次)
  - 数据库路径: /tmp/mdbx_bench_2billion

性能指标摘要:
  - 读取测试:
    ✓ Read 100000 KV pairs in 45.23 ms
    ✓ Read 100000 KV pairs in 44.87 ms
    ...
  - 写入测试:
    ✓ Wrote 100000 KV pairs in 67.45 ms
    ✓ Wrote 100000 KV pairs in 68.12 ms
    ...

平均延迟摘要:
    Average read latency: 2.15 μs
    Tp99 read latency: 4.50 μs
    Average write latency: 3.45 μs
    Tp99 write latency: 7.20 μs
    ...

吞吐量摘要:
    Read throughput: 2212389.45 ops/sec
    Write throughput: 1481481.48 ops/sec
    ...
=============================================================================
```

## 故障排除

### 常见问题

1. **构建失败**: 确保已安装所有依赖项，使用 `--clean` 选项重新构建
2. **内存不足**: 减少测试轮次或使用更小的数据集
3. **磁盘空间不足**: 清理旧日志文件或使用更大的存储设备
4. **权限问题**: 确保脚本有执行权限 `chmod +x bench_*.sh`

### 获取帮助

```bash
# 查看MDBX脚本帮助
./bench_mdbx_2billion.sh --help

# 查看RocksDB脚本帮助  
./bench_rocksdb_2billion.sh --help
```
